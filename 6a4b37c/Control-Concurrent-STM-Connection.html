<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Control.Concurrent.STM.Connection</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Control-Concurrent-STM-Connection.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Control-Concurrent-STM-Connection.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">stm-connection-0.1: Manage a stream connection with STM</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe-Inferred</td></tr></table><p class="caption">Control.Concurrent.STM.Connection</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Connection backend
</a></li><li><a href="#g:2">Configuration
</a></li><li><a href="#g:3">Exceptions
</a></li></ul></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><span class="keyword">data</span>  <a href="#t:Connection">Connection</a> r s</li><li class="src short"><a href="#v:new">new</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Config">Config</a> -&gt; <a href="Control-Concurrent-STM-Connection.html#t:Backend">Backend</a> r s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> (<a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s)</li><li class="src short"><a href="#v:close">close</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> ()</li><li class="src short"><a href="#v:recv">recv</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> (<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> r)</li><li class="src short"><a href="#v:send">send</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> ()</li><li class="src short"><a href="#v:cram">cram</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> ()</li><li class="src short"><a href="#v:isSendQueueEmpty">isSendQueueEmpty</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Bool.html#t:Bool">Bool</a></li><li class="src short"><a href="#v:bye">bye</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> ()</li><li class="src short"><span class="keyword">data</span>  <a href="#t:Backend">Backend</a> r s = <a href="#v:Backend">Backend</a> {<ul class="subs"><li><a href="#v:backendRecv">backendRecv</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> (<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> r))</li><li><a href="#v:backendSend">backendSend</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> ())</li><li><a href="#v:backendClose">backendClose</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> ())</li></ul>}</li><li class="src short"><span class="keyword">data</span>  <a href="#t:Config">Config</a>  = <a href="#v:Config">Config</a> {<ul class="subs"><li><a href="#v:configRecvLimit">configRecvLimit</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Int.html#t:Int">Int</a>)</li><li><a href="#v:configSendLimit">configSendLimit</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Int.html#t:Int">Int</a>)</li></ul>}</li><li class="src short"><a href="#v:defaultConfig">defaultConfig</a> :: <a href="Control-Concurrent-STM-Connection.html#t:Config">Config</a></li><li class="src short"><span class="keyword">data</span>  <a href="#t:Error">Error</a> <ul class="subs"><li>= <a href="#v:ErrorConnectionClosed">ErrorConnectionClosed</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-String.html#t:String">String</a>  </li><li>| <a href="#v:ErrorSentClose">ErrorSentClose</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-String.html#t:String">String</a>  </li></ul></li></ul></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:Connection" class="def">Connection</a> r s <a href="src/Control-Concurrent-STM-Connection.html#Connection" class="link">Source</a></p><div class="subs instances"><p id="control.i:Connection" class="caption collapser" onclick="toggleSection('i:Connection')">Instances</p><div id="section.i:Connection" class="show"><table><tr><td class="src"><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Eq.html#t:Eq">Eq</a> (<a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s)</td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><a name="v:new" class="def">new</a><a href="src/Control-Concurrent-STM-Connection.html#new" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="Control-Concurrent-STM-Connection.html#t:Config">Config</a></td><td class="doc"><p>Queue size limits.  Use <code><a href="Control-Concurrent-STM-Connection.html#v:defaultConfig">defaultConfig</a></code> for defaults.
</p></td></tr><tr><td class="src">-&gt; <a href="Control-Concurrent-STM-Connection.html#t:Backend">Backend</a> r s</td><td class="doc"><p>Callbacks for accessing the underlying device.
</p></td></tr><tr><td class="src">-&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> (<a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s)</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Wrap a connection handle so sending and receiving can be done with
 STM transactions.
</p></div></div><div class="top"><p class="src"><a name="v:close" class="def">close</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> ()<a href="src/Control-Concurrent-STM-Connection.html#close" class="link">Source</a></p><div class="doc"><p>Close the connection.  After this, <code><a href="Control-Concurrent-STM-Connection.html#v:recv">recv</a></code> and <code><a href="Control-Concurrent-STM-Connection.html#v:send">send</a></code> will fail.
</p><p><code><a href="Control-Concurrent-STM-Connection.html#v:close">close</a></code> will block until all queued data has been sent and the connection
 has been closed.  If <code><a href="Control-Concurrent-STM-Connection.html#v:close">close</a></code> is interrupted, it will abandon any data still
 sitting in the send queue, and finish closing the connection in the
 background.
</p></div></div><div class="top"><p class="src"><a name="v:recv" class="def">recv</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> (<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> r)<a href="src/Control-Concurrent-STM-Connection.html#recv" class="link">Source</a></p><div class="doc"><p>Receive the next message from the connection.  Return <code><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#v:Nothing">Nothing</a></code> on EOF.
 Throw an exception if the <code><a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a></code> is closed, or if the underlying
 <code><a href="Control-Concurrent-STM-Connection.html#v:backendRecv">backendRecv</a></code> failed.
</p><p>This will block if no messages are available right now.
</p></div></div><div class="top"><p class="src"><a name="v:send" class="def">send</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> ()<a href="src/Control-Concurrent-STM-Connection.html#send" class="link">Source</a></p><div class="doc"><p>Send a message on the connection.  Throw an exception if the
 <code><a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a></code> is closed, or if a <em>previous</em> <code><a href="Control-Concurrent-STM-Connection.html#v:backendSend">backendSend</a></code> failed.
</p><p>This will block if the send queue is full.
</p></div></div><div class="top"><p class="src"><a name="v:cram" class="def">cram</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> ()<a href="src/Control-Concurrent-STM-Connection.html#cram" class="link">Source</a></p><div class="doc"><p>Like <code><a href="Control-Concurrent-STM-Connection.html#v:send">send</a></code>, but never block, even if this causes the send queue to exceed
 <code><a href="Control-Concurrent-STM-Connection.html#v:configSendLimit">configSendLimit</a></code>.
</p></div></div><div class="top"><p class="src"><a name="v:isSendQueueEmpty" class="def">isSendQueueEmpty</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Bool.html#t:Bool">Bool</a><a href="src/Control-Concurrent-STM-Connection.html#isSendQueueEmpty" class="link">Source</a></p><div class="doc"><p>Test if the send queue is empty.  This is useful when sending dummy
 messages to keep the connection alive, to avoid queuing such messages when
 the connection is already congested with messages to send.
</p></div></div><div class="top"><p class="src"><a name="v:bye" class="def">bye</a> ::  <a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a> r s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/GHC-Conc.html#t:STM">STM</a> ()<a href="src/Control-Concurrent-STM-Connection.html#bye" class="link">Source</a></p><div class="doc"><p>Shut down the connection for sending, but keep the connection open so
 more data can be received.  Subsequent calls to <code><a href="Control-Concurrent-STM-Connection.html#v:send">send</a></code> and <code><a href="Control-Concurrent-STM-Connection.html#v:cram">cram</a></code>
 will fail.
</p></div></div><h1 id="g:1">Connection backend
</h1><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:Backend" class="def">Backend</a> r s <a href="src/Control-Concurrent-STM-Connection.html#Backend" class="link">Source</a></p><div class="doc"><p>Connection I/O driver.
</p><p><code><a href="Control-Concurrent-STM-Connection.html#v:backendSend">backendSend</a></code> and <code><a href="Control-Concurrent-STM-Connection.html#v:backendRecv">backendRecv</a></code> will often be called at the same time, so
 they must not block each other.  However, <code><a href="Control-Concurrent-STM-Connection.html#v:backendRecv">backendRecv</a></code> and <code><a href="Control-Concurrent-STM-Connection.html#v:backendSend">backendSend</a></code>
 are each called in their own thread, so it is safe to use
 <code><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-IORef.html#t:IORef">IORef</a></code>s to marshal state from call to call.
</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Backend" class="def">Backend</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:backendRecv" class="def">backendRecv</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> (<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> r))</dt><dd class="doc"><p>Receive the next message.  Return <code><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#v:Nothing">Nothing</a></code> on EOF.
</p></dd><dt class="src"><a name="v:backendSend" class="def">backendSend</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> s -&gt; <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> ())</dt><dd class="doc"><p>Send (and flush) the given message.
</p><p>If <code><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#v:Nothing">Nothing</a></code> is given, shut down the underlying connection for
   sending, as <code><a href="Control-Concurrent-STM-Connection.html#v:backendSend">backendSend</a></code> will not be called again.  If your device
   does not support this, do nothing.
</p></dd><dt class="src"><a name="v:backendClose" class="def">backendClose</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/System-IO.html#t:IO">IO</a> ())</dt><dd class="doc"><p>Close the device.  <code><a href="Control-Concurrent-STM-Connection.html#v:backendSend">backendSend</a></code> and <code><a href="Control-Concurrent-STM-Connection.html#v:backendRecv">backendRecv</a></code> are never
   called during or after this.
</p><p><code><a href="Control-Concurrent-STM-Connection.html#v:backendClose">backendClose</a></code> is called when the <code><a href="Control-Concurrent-STM-Connection.html#t:Connection">Connection</a></code> is done using the
   device, even if you don't use <code><a href="Control-Concurrent-STM-Connection.html#v:close">close</a></code>.
</p></dd></dl><div class="clear"></div></div></td></tr></table></div></div><h1 id="g:2">Configuration
</h1><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:Config" class="def">Config</a>  <a href="src/Control-Concurrent-STM-Connection.html#Config" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Config" class="def">Config</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:configRecvLimit" class="def">configRecvLimit</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Int.html#t:Int">Int</a>)</dt><dd class="doc"><p>Default: <code><code><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#v:Just">Just</a></code> 10</code>
</p><p>Number of messages that may sit in the receive queue before the
   <code>Connection'</code>s receiving thread blocks.  Having a limit is
   recommended in case the client produces messages faster than your
   program consumes them.
</p></dd><dt class="src"><a name="v:configSendLimit" class="def">configSendLimit</a> :: !(<a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#t:Maybe">Maybe</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Int.html#t:Int">Int</a>)</dt><dd class="doc"><p>Default: <code><code><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Maybe.html#v:Just">Just</a></code> 10</code>
</p><p>Number of messages that may sit in the send queue before <code><a href="Control-Concurrent-STM-Connection.html#v:send">send</a></code>
   blocks.  Having a limit is recommended if your program produces
   messages faster than they can be sent.
</p></dd></dl><div class="clear"></div></div></td></tr></table></div><div class="subs instances"><p id="control.i:Config" class="caption collapser" onclick="toggleSection('i:Config')">Instances</p><div id="section.i:Config" class="show"><table><tr><td class="src"><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Default.html#t:Default">Default</a> <a href="Control-Concurrent-STM-Connection.html#t:Config">Config</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><a name="v:defaultConfig" class="def">defaultConfig</a> :: <a href="Control-Concurrent-STM-Connection.html#t:Config">Config</a><a href="src/Control-Concurrent-STM-Connection.html#defaultConfig" class="link">Source</a></p></div><h1 id="g:3">Exceptions
</h1><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:Error" class="def">Error</a>  <a href="src/Control-Concurrent-STM-Connection.html#Error" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:ErrorConnectionClosed" class="def">ErrorConnectionClosed</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-String.html#t:String">String</a></td><td class="doc"><p>connection <code><a href="Control-Concurrent-STM-Connection.html#v:close">close</a></code>d
</p></td></tr><tr><td class="src"><a name="v:ErrorSentClose" class="def">ErrorSentClose</a> <a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-String.html#t:String">String</a></td><td class="doc"><p>connection shut down for sending
</p></td></tr></table></div><div class="subs instances"><p id="control.i:Error" class="caption collapser" onclick="toggleSection('i:Error')">Instances</p><div id="section.i:Error" class="show"><table><tr><td class="src"><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Text-Show.html#t:Show">Show</a> <a href="Control-Concurrent-STM-Connection.html#t:Error">Error</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Data-Typeable-Internal.html#t:Typeable">Typeable</a> <a href="Control-Concurrent-STM-Connection.html#t:Error">Error</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a href="http://www.haskell.org/ghc/docs/latest/html/libraries/base/Control-Exception-Base.html#t:Exception">Exception</a> <a href="Control-Concurrent-STM-Connection.html#t:Error">Error</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.13.2</p></div></body></html>